{"version":3,"sources":["../../src/middlewares/Auth/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/* eslint-disable @typescript-eslint/no-non-null-assertion */\nimport Permissions from '../../constants/userPermissions';\nimport RoleModel from '../../features/userRoles/models';\nimport TokenGEN from '../../utils/jwt/tokenGEN';\nimport UserModel from '../../features/users/models';\nimport { environmentConfig } from '../../config';\nimport jwt from 'jsonwebtoken';\nimport { INext, IRequest, IResponse, JWTPayloadType } from '../../common/types';\n\n\nconst verifyCookie = (req: IRequest, res: IResponse, next: INext) => {\n\ttry {\n\t\tif (!req.cookies) {\n\t\t\treturn res.status(401).json({\n\t\t\t\tmessage: 'Please login to access this page',\n\t\t\t\tstatus: 'warning',\n\t\t\t\tstatusCode: 401,\n\t\t\t\tdata: {}\n\t\t\t});\n\t\t}\n\t\tconst token = req.cookies['access_token'];\n\t\tif (!token) {\n\t\t\treturn res.status(401).json({\n\t\t\t\tmessage: 'Please login to access this page',\n\t\t\t\tstatus: 'warning',\n\t\t\t\tstatusCode: 401,\n\t\t\t\tdata: {}\n\t\t\t});\n\t\t}\n\t\tconst jwtToken = TokenGEN.decodeEncodedToken(token);\n\t\tif (!jwtToken) {\n\t\t\treturn res.status(401).json({\n\t\t\t\tmessage: 'Please login to access this page',\n\t\t\t\tstatus: 'warning',\n\t\t\t\tstatusCode: 401,\n\t\t\t\tdata: {}\n\t\t\t});\n\t\t}\n\t\tconst payload = jwt.verify(\n\t\t\tjwtToken,\n\t\t\tenvironmentConfig.SECRET_KEY\n\t\t) as JWTPayloadType;\n\t\treq.user = payload;\n\n\t\treturn next();\n\t} catch {\n\t\treturn res.status(401).json({\n\t\t\tmessage: 'Login session has expired',\n\t\t\tstatus: 'warning',\n\t\t\tstatusCode: 401,\n\t\t\tdata: {}\n\t\t});\n\t}\n};\n\nexport const\tloginRequired = async (req: IRequest, res: IResponse, next: INext) => {\n\ttry {\n\t\tverifyCookie(req, res, async () => {\n\t\t\tconst user = await UserModel.findById(req.user.userId);\n\t\t\tif(!user){\n\t\t\t\treturn res.status(401).json({\n\t\t\t\t\tmessage: 'Please login to access this page',\n\t\t\t\t\tstatus: 'warning',\n\t\t\t\t\tstatusCode: 401,\n\t\t\t\t\tdata: {}\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (!user!.isActive) {\n\t\t\t\treturn res.status(401).json({\n\t\t\t\t\tmessage: 'Please activate your account',\n\t\t\t\t\tstatus: 'warning',\n\t\t\t\t\tstatusCode: 401,\n\t\t\t\t\tdata: {}\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst role = await RoleModel.findById(user!.role);\n\t\t\tconst permitted =  role!.hasPermission(Permissions.USER);\n\t\t\tif (!permitted) \n\t\t\t\treturn res.sendStatus(403);\n\t\t\t\t\n\t\t\treturn next();\n\t\t});\n\t} catch (error) {\n\t\treturn next(error);\n\t}\n};\n\nexport const adminRequired = async (req: IRequest, res: IResponse, next: INext) => {\n\ttry {\n\t\tloginRequired(req, res, async () => {\n\t\t\tconst user = await UserModel.findById(req.user.userId);\n\t\t\tconst role = await RoleModel.findById(user!.role);\n\t\t\tconst permitted =  role!.hasPermission(Permissions.ADMIN);\n\t\t\tif (!permitted) \n\t\t\t\treturn res.sendStatus(403);\n\t\t\t\t\n\t\t\treturn next();\n\t\t});\n\t} catch (error) {\n\t\treturn next(error);\n\t}\n};\n\n"]}